#!/bin/bash

# Exit on error
set -e


ZABBIX_SERVER=192.168.100.100
ZABBIX_AGENT_TAR_GZ_PATH=/opt/zabbix-agent/zabbix_agent-7.tar.gz

# Get the Linux machine's hostname
HOSTNAME=$(hostname)



# Create a directory for Zabbix Agent installation
echo "Creating directory for Zabbix Agent installation..."
INSTALL_DIR="/opt/zabbix-agent"
sudo mkdir -p $INSTALL_DIR
cd $INSTALL_DIR
curl -O http://ex.site.local/zabbix_agent-7.tar.gz
##cp /home/yaas/zabbix_agent-7.tar.gz .

# Extract the tar.gz file to the installation directory
echo "Extracting Zabbix agent tarball to $INSTALL_DIR..."
sudo tar -xvzf "$ZABBIX_AGENT_TAR_GZ_PATH" 

# Check if extraction was successful
if [ $? -ne 0 ]; then
    echo "Error: Failed to extract Zabbix agent tarball."
    exit 1
fi


### user & group creating:
#### RedHat
groupadd --system zabbix
useradd --system -g zabbix -d /usr/lib/zabbix -s /sbin/nologin -c "Zabbix Monitoring System" zabbix

mkdir -m u=rwx,g=rwx,o= -p /usr/lib/zabbix
chown zabbix:zabbix /usr/lib/zabbix

### Creating Log DIR:
NEW_LOG_FILE="/var/log/zabbix/zabbix_agentd.log"
mkdir /var/log/zabbix
chown -R zabbix:zabbix /var/log/zabbix

export CFLAGS="-std=gnu99"

# Set up systemd service
echo "Creating systemd service for Zabbix Agent..."

SERVICE_FILE="/etc/systemd/system/zabbix-agentd.service"

sudo bash -c "cat > $SERVICE_FILE <<EOL
[Unit]
Description=Zabbix Agent
After=network.target

[Service]
Type=simple
ExecStart=$INSTALL_DIR/sbin/zabbix_agentd -f
ExecStop=$INSTALL_DIR/sbin/zabbix_agentd -r
PIDFile=/var/run/zabbix/zabbix_agentd.pid
Restart=always
User=zabbix
Group=zabbix
LimitNOFILE=1024
TimeoutStopSec=30

[Install]
WantedBy=multi-user.target
EOL"

# Reload systemd to read the new service file
echo "Reloading systemd manager..."
sudo systemctl daemon-reload

# Enable Zabbix agent service to start on boot
echo "Enabling Zabbix agent service to start on boot..."
sudo systemctl enable zabbix-agentd.service

# Start the Zabbix agent service
echo "Starting Zabbix agent service..."
sudo systemctl start zabbix-agentd.service

# Configure the Zabbix agent with the provided server and the Linux machine's hostname
echo "Configuring Zabbix agent with Zabbix server: $ZABBIX_SERVER and Hostname: $HOSTNAME..."
sudo sed -i "s/^Server=127.0.0.1/Server=$ZABBIX_SERVER/" $INSTALL_DIR/conf/zabbix_agentd.conf
sudo sed -i "s/^Hostname=Zabbix server/Hostname=$HOSTNAME/" $INSTALL_DIR/conf/zabbix_agentd.conf
sudo sed -i "s/^# AllowRoot=0/AllowRoot=1/" $INSTALL_DIR/conf/zabbix_agentd.conf
sudo sed -i "s|^LogFile=.*|LogFile=$NEW_LOG_FILE|" $INSTALL_DIR/conf/zabbix_agentd.conf
sudo cp  $INSTALL_DIR/conf/zabbix_agentd.conf /usr/local/etc/zabbix_agentd.conf

# Restart the Zabbix agent service to apply changes
echo "Restarting Zabbix agent service to apply new configuration..."
sudo systemctl restart zabbix-agentd.service

# Check the status of the service
echo "Checking the status of Zabbix agent service..."
sudo systemctl status zabbix-agentd.service

# End of script
echo "Zabbix Agent installation from tarball and service setup complete!"

